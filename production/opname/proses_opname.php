<?php     require_once("../penghubung.inc.php");  require_once($ROOT."lib/login.php");  require_once($ROOT."lib/encrypt.php");  require_once($ROOT."lib/datamodel.php");  require_once($ROOT."lib/currency.php");  require_once($ROOT."lib/dateLib.php");  require_once($ROOT."lib/expAJAX.php");  require_once($ROOT."lib/tampilan.php");  $view = new CView($_SERVER['PHP_SELF'],$_SERVER['QUERY_STRING']);  $dtaccess = new DataAccess();  $enc = new TextEncrypt();       $auth = new CAuth();  $table = new InoTable("table","100%","left");  $usrId = $auth->GetUserId();  $depNama = $auth->GetDepNama();  $depId = $auth->GetDepId();  $userName = $auth->GetUserName();     if($_POST['act'] == "simpan"){          $sql = "select penerimaan_periode_tanggal_awal, penerimaan_periode_tanggal_akhir from logistik.logistik_penerimaan_periode where            penerimaan_periode_id = ".QuoteValue(DPE_CHAR,$periode_bulan_awal);         $dataPeriodeOpname = $dtaccess->Fetch($sql);         $opname_id = $_POST['id_opname'];         $tgl = date_format(date_create($_POST['tgl']), "Y-m-d");         $tglWaktu = $tgl. " ".$_POST['waktu'];         $id_item = $_POST['id_item'];         /* SIMPAN OPNAME */         $dbTable = "logistik.logistik_opname";                   $dbField[0] = "opname_id";   // PK         $dbField[1] = "opname_tanggal";         $dbField[2] = "id_dep";         $dbField[3] = "id_gudang";         $dbField[4] = "id_periode";         $dbField[5] = "opname_flag";         $dbField[6] = "opname_waktu";         $dbField[7] = "opname_keterangan";         $dbField[8] = "status_verifikasi";         $opname_id = ($opname_id) ? $opname_id : $dtaccess->GetTransID();                  $dbValue[0] = QuoteValue(DPE_CHAR, $opname_id);         $dbValue[1] = QuoteValue(DPE_DATE, $tgl);         $dbValue[2] = QuoteValue(DPE_CHAR, $depId);         $dbValue[3] = QuoteValue(DPE_CHAR, $_POST['gudang']);         $dbValue[4] = QuoteValue(DPE_CHAR, $_POST['id_periode']);         $dbValue[5] = QuoteValue(DPE_CHAR, 'M');         $dbValue[6] = QuoteValue(DPE_DATE, $_POST['waktu']);         $dbValue[7] = QuoteValue(DPE_CHAR, $_POST['keterangan_op']);         $dbValue[8] = QuoteValue(DPE_CHAR, "n");         $dbKey[0] = 0; // -- set key buat clause wherenya , valuenya = index array buat field / value         $dtmodel = new DataModel($dbTable,$dbField,$dbValue,$dbKey);         if ($_POST['id_opname'] == '') $dtmodel->Insert() or die("insert  error");         unset($dtmodel);         unset($dbField);         unset($dbValue);         unset($dbKey);          /* SIMPAN OPNAME */         $sql = "SELECT max(opname_detail_urut) as terakhir from logistik.logistik_opname_detail where id_opname = '$opname_id'";         $dataNomorterakhir = $dtaccess->Fetch($sql);         $nomor = $dataNomorterakhir['terakhir'] + 1;         $sql = "SELECT item_hpp from logistik.logistik_item where item_id = '$id_item'";         $dataHPP = $dtaccess->Fetch($sql);          $dbTable = "logistik.logistik_opname_detail";                   $dbField[0] = "opname_detail_id";   // PK         $dbField[1] = "id_opname";         $dbField[2] = "id_item";         $dbField[3] = "opname_detail_jumlah";         $dbField[4] = "item_nama";         $dbField[5] = "opname_detail_jumlah_sebelumnya";         $dbField[6] = "opname_detail_realtime";         $dbField[7] = "opname_detail_selisih";         $dbField[8] = "opname_detail_keterangan";         $dbField[9] = "opname_detail_hpp";         $dbField[10] = "opname_detail_urut";                  $detOpnameId = $dtaccess->GetTransID();                  $dbValue[0] = QuoteValue(DPE_CHAR, $detOpnameId);         $dbValue[1] = QuoteValue(DPE_DATE, $opname_id);         $dbValue[2] = QuoteValue(DPE_CHAR, $_POST['id_item']);         $dbValue[3] = QuoteValue(DPE_CHAR, $_POST['stok_real']);         $dbValue[4] = QuoteValue(DPE_CHAR, $_POST['nama_item']);         $dbValue[5] = QuoteValue(DPE_CHAR, $_POST['stok_prev']);         $dbValue[6] = QuoteValue(DPE_DATE, $tglWaktu);         $dbValue[7] = QuoteValue(DPE_CHAR, $_POST['stok_selisih']);         $dbValue[8] = QuoteValue(DPE_CHAR, $_POST['keterangan']);         $dbValue[9] = QuoteValue(DPE_CHAR, $dataHPP['item_hpp']);         $dbValue[10] = QuoteValue(DPE_CHAR, $nomor);                  $dbKey[0] = 0; // -- set key buat clause wherenya , valuenya = index array buat field / value         $dtmodel = new DataModel($dbTable,$dbField,$dbValue,$dbKey);         if ($_POST['opname_id'] == '') $dtmodel->Insert() or die("insert  error");         unset($dtmodel);         unset($dbField);         unset($dbValue);         unset($dbKey);          $sql = "SELECT * from logistik.logistik_opname_detail a          left join logistik.logistik_item b on a.id_item = b.item_id          where opname_detail_id = '$detOpnameId'";         $data = $dtaccess->Fetch($sql);         echo json_encode($data);     }     else if($_POST['act'] == "delete"){          $detOpnameId = $_POST['opnameDetId'];          $id_opname = $_POST['id_opname'];          $sql = "DELETE from logistik.logistik_opname_detail where opname_detail_id = '$detOpnameId'";          $dtaccess->Execute($sql);          $sql = "SELECT opname_detail_id from logistik.logistik_opname_detail where id_opname = '$id_opname' order by opname_detail_urut";          $dataRow = $dtaccess->FetchAll($sql);          for($i = 0;$i < count($dataRow); $i++){            $reArrange = $i+1;            $idDetOpname = $dataRow[$i]['opname_detail_id'];            $sql = "UPDATE logistik.logistik_opname_detail set opname_detail_urut = '$reArrange' where opname_detail_id = '$idDetOpname'";            $dtaccess->Execute($sql);          }          echo "Deleted";     }               	   ?>